<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Test - ScreenShare</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 font-sans p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-8">Audio Capture Test</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Desktop Audio Test -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Desktop Audio Capture</h2>
                <p class="text-gray-600 mb-4">Test capturing audio from your desktop/screen</p>
                
                <button id="test-desktop-audio" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors mb-4">
                    Test Desktop Audio
                </button>
                
                <div id="desktop-audio-status" class="text-sm text-gray-600"></div>
                <audio id="desktop-audio" controls class="w-full mt-4"></audio>
            </div>
            
            <!-- Microphone Audio Test -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Microphone Audio Capture</h2>
                <p class="text-gray-600 mb-4">Test capturing audio from your microphone</p>
                
                <button id="test-mic-audio" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors mb-4">
                    Test Microphone
                </button>
                
                <div id="mic-audio-status" class="text-sm text-gray-600"></div>
                <audio id="mic-audio" controls class="w-full mt-4"></audio>
            </div>
        </div>
        
        <!-- Combined Stream Test -->
        <div class="bg-white rounded-lg shadow-md p-6 mt-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Combined Stream Test</h2>
            <p class="text-gray-600 mb-4">Test combining video and audio streams</p>
            
            <button id="test-combined" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors mb-4">
                Test Combined Stream
            </button>
            
            <div id="combined-status" class="text-sm text-gray-600"></div>
            <video id="combined-video" controls class="w-full mt-4 bg-gray-900 rounded"></video>
        </div>
        
        <!-- Audio Quality Controls -->
        <div class="bg-white rounded-lg shadow-md p-6 mt-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Audio Quality Controls</h2>
            <p class="text-gray-600 mb-4">Adjust audio processing to reduce noise and improve quality</p>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Noise Reduction</label>
                    <select id="noise-reduction" class="w-full p-2 border border-gray-300 rounded">
                        <option value="none">None</option>
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Echo Cancellation</label>
                    <select id="echo-cancellation" class="w-full p-2 border border-gray-300 rounded">
                        <option value="false">Disabled</option>
                        <option value="true" selected>Enabled</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Sample Rate</label>
                    <select id="sample-rate" class="w-full p-2 border border-gray-300 rounded">
                        <option value="22050">22.05 kHz</option>
                        <option value="44100">44.1 kHz</option>
                        <option value="48000" selected>48 kHz</option>
                    </select>
                </div>
            </div>
            
            <button id="apply-audio-settings" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition-colors">
                Apply Audio Settings
            </button>
            
            <div id="audio-settings-status" class="text-sm text-gray-600 mt-2"></div>
        </div>
        
        <!-- Noise Reduction Test -->
        <div class="bg-white rounded-lg shadow-md p-6 mt-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Noise Reduction Test</h2>
            <p class="text-gray-600 mb-4">Test different noise reduction algorithms</p>
            
            <button id="test-noise-reduction" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors mb-4">
                Test Noise Reduction
            </button>
            
            <div id="noise-reduction-status" class="text-sm text-gray-600"></div>
            <audio id="processed-audio" controls class="w-full mt-4"></audio>
        </div>
        
        <!-- Log Output -->
        <div class="bg-white rounded-lg shadow-md p-6 mt-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Debug Log</h2>
            <div id="debug-log" class="bg-gray-100 p-4 rounded text-sm font-mono text-gray-800 max-h-64 overflow-y-auto"></div>
        </div>
    </div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        // Test desktop audio capture
        document.getElementById('test-desktop-audio').addEventListener('click', async () => {
            try {
                log('üéµ Testing desktop audio capture...');
                
                // First get display sources
                const sources = await navigator.mediaDevices.getDisplayMedia({
                    video: true,
                    audio: true
                });
                
                log(`üì∫ Got ${sources.getTracks().length} tracks from display media`);
                
                const audioTracks = sources.getAudioTracks();
                const videoTracks = sources.getVideoTracks();
                
                log(`üéµ Audio tracks: ${audioTracks.length}`);
                log(`üé¨ Video tracks: ${videoTracks.length}`);
                
                if (audioTracks.length > 0) {
                    audioTracks.forEach((track, index) => {
                        log(`üîä Audio track ${index}: ${track.label} (enabled: ${track.enabled}, muted: ${track.muted})`);
                    });
                    
                    // Play the audio
                    const audio = document.getElementById('desktop-audio');
                    audio.srcObject = sources;
                    document.getElementById('desktop-audio-status').textContent = '‚úÖ Desktop audio captured successfully';
                    log('‚úÖ Desktop audio playing');
                } else {
                    document.getElementById('desktop-audio-status').textContent = '‚ùå No audio tracks found in desktop capture';
                    log('‚ùå No audio tracks in desktop capture');
                }
                
            } catch (error) {
                log(`‚ùå Desktop audio test failed: ${error.message}`);
                document.getElementById('desktop-audio-status').textContent = `‚ùå Error: ${error.message}`;
            }
        });

        // Test microphone audio capture
        document.getElementById('test-mic-audio').addEventListener('click', async () => {
            try {
                log('üé§ Testing microphone audio capture...');
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    }
                });
                
                const audioTracks = stream.getAudioTracks();
                log(`üé§ Got ${audioTracks.length} microphone audio tracks`);
                
                if (audioTracks.length > 0) {
                    audioTracks.forEach((track, index) => {
                        log(`üé§ Audio track ${index}: ${track.label} (enabled: ${track.enabled}, muted: ${track.muted})`);
                    });
                    
                    // Play the audio
                    const audio = document.getElementById('mic-audio');
                    audio.srcObject = stream;
                    document.getElementById('mic-audio-status').textContent = '‚úÖ Microphone audio captured successfully';
                    log('‚úÖ Microphone audio playing');
                } else {
                    document.getElementById('mic-audio-status').textContent = '‚ùå No microphone audio tracks found';
                    log('‚ùå No microphone audio tracks');
                }
                
            } catch (error) {
                log(`‚ùå Microphone audio test failed: ${error.message}`);
                document.getElementById('mic-audio-status').textContent = `‚ùå Error: ${error.message}`;
            }
        });

        // Test combined stream
        document.getElementById('test-combined').addEventListener('click', async () => {
            try {
                log('üé¨ Testing combined stream...');
                
                // Get display media
                const displayStream = await navigator.mediaDevices.getDisplayMedia({
                    video: true,
                    audio: true
                });
                
                log(`üì∫ Display stream: ${displayStream.getTracks().length} tracks`);
                
                // Try to get additional audio
                let combinedStream = displayStream;
                
                try {
                    const audioStream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: false,
                            noiseSuppression: false,
                            autoGainControl: false
                        }
                    });
                    
                    // Add audio tracks to display stream
                    audioStream.getAudioTracks().forEach(track => {
                        combinedStream.addTrack(track);
                        log(`üîä Added additional audio track: ${track.label}`);
                    });
                    
                } catch (audioError) {
                    log(`‚ö†Ô∏è Could not add additional audio: ${audioError.message}`);
                }
                
                const totalTracks = combinedStream.getTracks().length;
                const audioTracks = combinedStream.getAudioTracks().length;
                const videoTracks = combinedStream.getVideoTracks().length;
                
                log(`üé¨ Combined stream: ${totalTracks} total tracks (${videoTracks} video, ${audioTracks} audio)`);
                
                if (totalTracks > 0) {
                    // Play the combined stream
                    const video = document.getElementById('combined-video');
                    video.srcObject = combinedStream;
                    document.getElementById('combined-status').textContent = `‚úÖ Combined stream playing (${totalTracks} tracks)`;
                    log('‚úÖ Combined stream playing');
                } else {
                    document.getElementById('combined-status').textContent = '‚ùå No tracks in combined stream';
                    log('‚ùå No tracks in combined stream');
                }
                
            } catch (error) {
                log(`‚ùå Combined stream test failed: ${error.message}`);
                document.getElementById('combined-status').textContent = `‚ùå Error: ${error.message}`;
            }
        });

        log('üöÄ Audio test page loaded');
        log('üí° Click the test buttons to check audio capture capabilities');
    </script>
    
    <script>
        // Audio quality controls functionality
        let currentAudioContext = null;
        let currentAudioSource = null;
        let currentAudioProcessor = null;
        
        // Apply audio settings
        document.getElementById('apply-audio-settings').addEventListener('click', () => {
            const noiseReduction = document.getElementById('noise-reduction').value;
            const echoCancellation = document.getElementById('echo-cancellation').value === 'true';
            const sampleRate = parseInt(document.getElementById('sample-rate').value);
            
            log(`üîß Applying audio settings: Noise=${noiseReduction}, Echo=${echoCancellation}, SampleRate=${sampleRate}Hz`);
            
            // Update the current audio stream with new settings
            updateAudioSettings(noiseReduction, echoCancellation, sampleRate);
            
            document.getElementById('audio-settings-status').textContent = '‚úÖ Audio settings applied';
        });
        
        // Test noise reduction
        document.getElementById('test-noise-reduction').addEventListener('click', async () => {
            try {
                log('üîá Testing noise reduction...');
                
                // Get a test audio stream
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 48000
                    }
                });
                
                if (window.AudioContext || window.webkitAudioContext) {
                    // Create audio context for processing
                    currentAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                    currentAudioSource = currentAudioContext.createMediaStreamSource(stream);
                    
                    // Create audio processing chain
                    const gainNode = currentAudioContext.createGain();
                    const biquadFilter = currentAudioContext.createBiquadFilter();
                    const compressor = currentAudioContext.createDynamicsCompressor();
                    
                    // Configure noise reduction filter
                    biquadFilter.type = 'highpass';
                    biquadFilter.frequency.value = 80; // Cut off low frequencies
                    biquadFilter.Q.value = 1;
                    
                    // Configure compressor for dynamic range compression
                    compressor.threshold.value = -24;
                    compressor.knee.value = 30;
                    compressor.ratio.value = 12;
                    compressor.attack.value = 0.003;
                    compressor.release.value = 0.25;
                    
                    // Connect the audio processing chain
                    currentAudioSource.connect(biquadFilter);
                    biquadFilter.connect(compressor);
                    compressor.connect(gainNode);
                    gainNode.connect(currentAudioContext.destination);
                    
                    // Set gain
                    gainNode.gain.value = 0.8;
                    
                    log('‚úÖ Noise reduction processing applied');
                    document.getElementById('noise-reduction-status').textContent = '‚úÖ Noise reduction processing active';
                    
                    // Play the processed audio
                    const audio = document.getElementById('processed-audio');
                    audio.srcObject = stream;
                    
                } else {
                    log('‚ö†Ô∏è Web Audio API not supported');
                    document.getElementById('noise-reduction-status').textContent = '‚ö†Ô∏è Web Audio API not supported';
                }
                
            } catch (error) {
                log(`‚ùå Noise reduction test failed: ${error.message}`);
                document.getElementById('noise-reduction-status').textContent = `‚ùå Error: ${error.message}`;
            }
        });
        
        // Update audio settings for current stream
        function updateAudioSettings(noiseLevel, echoCancel, sampleRate) {
            if (!currentAudioContext || !currentAudioSource) {
                log('‚ö†Ô∏è No active audio stream to update');
                return;
            }
            
            try {
                // Update filter settings based on noise reduction level
                const filter = currentAudioContext.createBiquadFilter();
                filter.type = 'highpass';
                
                switch (noiseLevel) {
                    case 'low':
                        filter.frequency.value = 60;
                        break;
                    case 'medium':
                        filter.frequency.value = 80;
                        break;
                    case 'high':
                        filter.frequency.value = 120;
                        break;
                    default:
                        filter.frequency.value = 80;
                }
                
                log(`üîß Updated noise reduction filter: ${filter.frequency.value}Hz`);
                
                // Update sample rate if supported
                if (currentAudioContext.sampleRate !== sampleRate) {
                    log(`üîß Sample rate change requested: ${currentAudioContext.sampleRate}Hz ‚Üí ${sampleRate}Hz`);
                    log('üí° Note: Sample rate changes require stream restart');
                }
                
            } catch (error) {
                log(`‚ùå Failed to update audio settings: ${error.message}`);
            }
        }
        
        // Clean up audio context when page unloads
        window.addEventListener('beforeunload', () => {
            if (currentAudioContext) {
                currentAudioContext.close();
            }
        });
    </script>
</body>
</html>
